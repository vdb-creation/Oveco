---
/**
 * SearchWorks Component - Oveco
 * Barre de recherche et tags pour filtrer les projets sur la page works
 * 
 * @component
 */

import { getAllProjects } from '../lib/projects';

// Charger tous les projets pour extraire les compétences uniques
const allProjects = await getAllProjects();

// Extraire toutes les compétences uniques depuis les projets
const allCompetences = new Set<string>();
allProjects.forEach(project => {
  if (project.competences && Array.isArray(project.competences)) {
    project.competences.forEach((comp: any) => {
      if (comp.title) {
        allCompetences.add(comp.title);
      }
    });
  }
});

const competences = Array.from(allCompetences).sort();
---

<section class="search-works-section" id="search-works">
  <div class="search-works__container">
    <div class="search-works__wrapper">
      <!-- Barre de recherche -->
      <div class="search-works__search-box">
        <div class="search-works__input-label-wrapper">
          <label for="search-works-input" class="search-works__input-label">Chercher un projet</label>
        </div>
        <input
          type="text"
          id="search-works-input"
          class="search-works__input-real"
          placeholder=""
          aria-label="Rechercher un projet"
        />
        <div class="search-works__icon-wrapper" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7" cy="7" r="5" stroke="#5C6D6F" stroke-width="1.5" fill="none"/>
            <path d="M11 11L14 14" stroke="#5C6D6F" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <!-- Bouton reset (visible si texte) -->
        <button type="button" id="search-works-reset" class="search-works__reset" aria-label="Effacer la recherche" hidden>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5 3.5L3.5 10.5" stroke="#5C6D6F" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M3.5 3.5L10.5 10.5" stroke="#5C6D6F" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Tags des compétences -->
      <div class="search-works__tags">
        {competences.length > 0 ? (
          competences.map((competence, index) => (
            <button
              type="button"
              class="search-works__tag"
              data-tag={competence}
              aria-label={`Filtrer par ${competence}`}
            >
              <div class="search-works__tag-content">
                <div class="search-works__tag-text">{competence}</div>
              </div>
            </button>
          ))
        ) : (
          <span class="search-works__no-tags">Aucune compétence disponible</span>
        )}
      </div>
    </div>
  </div>
</section>

<script>
  // Système de filtrage par recherche et tags avec URL Sync et Debounce
  function initSearchWorks() {
    const searchInput = document.getElementById('search-works-input') as HTMLInputElement;
    const resetButton = document.getElementById('search-works-reset') as HTMLButtonElement;
    const tags = document.querySelectorAll('.search-works__tag') as NodeListOf<HTMLButtonElement>;
    const projectsGrid = document.querySelector('[data-works-grid]') as HTMLElement;
    
    if (!searchInput || !projectsGrid) {
      console.warn('[SearchWorks] Éléments non trouvés');
      return;
    }

    let selectedTags: string[] = [];
    let searchQuery: string = '';

    // Debounce function
    function debounce(func: Function, wait: number) {
      let timeout: any;
      return function executedFunction(...args: any[]) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Mettre à jour l'URL
    function updateURL() {
      const url = new URL(window.location.href);
      
      if (searchQuery) {
        url.searchParams.set('q', searchQuery);
      } else {
        url.searchParams.delete('q');
      }

      if (selectedTags.length > 0) {
        url.searchParams.set('tags', selectedTags.join(','));
      } else {
        url.searchParams.delete('tags');
      }

      window.history.replaceState({}, '', url);
    }

    // Lire l'URL
    function readURL() {
      const params = new URLSearchParams(window.location.search);
      searchQuery = params.get('q') || '';
      const tagsParam = params.get('tags');
      selectedTags = tagsParam ? tagsParam.split(',') : [];

      // Restaurer l'état UI
      if (searchInput) {
        searchInput.value = searchQuery;
        // Gérer le label
        const wrapper = searchInput.closest('.search-works__search-box');
        const labelWrapper = wrapper?.querySelector('.search-works__input-label-wrapper') as HTMLElement;
        if (searchQuery && labelWrapper) {
          labelWrapper.style.opacity = '0';
          labelWrapper.style.width = '0';
        }
        toggleResetButton();
      }

      tags.forEach(tag => {
        const tagValue = tag.getAttribute('data-tag') || '';
        if (selectedTags.includes(tagValue)) {
          tag.classList.add('search-works__tag--active');
        } else {
          tag.classList.remove('search-works__tag--active');
        }
      });

      filterProjects();
    }

    // Afficher/Masquer le bouton reset
    function toggleResetButton() {
      if (resetButton) {
        if (searchQuery.length > 0) {
          resetButton.hidden = false;
        } else {
          resetButton.hidden = true;
        }
      }
    }

    // Fonction de filtrage principale
    function filterProjects() {
      const cards = projectsGrid.querySelectorAll('.projects__card') as NodeListOf<HTMLElement>;
      let visibleCount = 0;

      cards.forEach((card) => {
        const cardElement = card as HTMLElement;
        
        // Récupérer les données
        const cardProjectTitle = card.getAttribute('data-project-title') || '';
        const cardProjectType = card.getAttribute('data-project-type') || '';
        const cardProjectDescription = card.getAttribute('data-project-description') || '';
        const cardProjectClient = card.getAttribute('data-project-client') || '';
        const cardCompetences = card.getAttribute('data-competences') || '';
        
        // Fallback DOM
        const cardTitle = cardProjectTitle || card.querySelector('.projects__card-title')?.textContent?.toLowerCase() || '';
        const cardDescription = cardProjectDescription || card.querySelector('.projects__card-description')?.textContent?.toLowerCase() || '';
        const cardType = cardProjectType || card.querySelector('.projects__card-type')?.textContent?.toLowerCase() || '';
        const cardClient = cardProjectClient || card.querySelector('.projects__card-client')?.textContent?.toLowerCase() || '';
        
        // Vérifier la recherche textuelle (plus flexible: split par mots)
        const searchLower = searchQuery.toLowerCase();
        const searchTerms = searchLower.split(' ').filter(t => t.length > 0);
        
        const matchesSearch = searchTerms.length === 0 || searchTerms.every(term => 
          cardTitle.includes(term) ||
          cardDescription.includes(term) ||
          cardType.includes(term) ||
          cardClient.includes(term) ||
          cardCompetences.includes(term)
        );

        // Vérifier les tags (ET logique ou OU logique ? Ici OU: si un des tags sélectionnés est présent)
        // Si on veut un filtrage strict (tous les tags présents), changer .some() en .every()
        let matchesTags = true;
        if (selectedTags.length > 0) {
          // Logique "OU" : affiche si le projet a au moins un des tags sélectionnés
          // Logique "ET" : affiche si le projet a tous les tags sélectionnés
          // Pour des compétences, souvent "OU" est plus permissif, mais "ET" est plus précis.
          // Utilisons "OU" pour être moins restrictif par défaut
          matchesTags = selectedTags.some(tag => {
            const tagLower = tag.toLowerCase();
            return cardCompetences.includes(tagLower) ||
                   cardType.includes(tagLower) ||
                   cardTitle.includes(tagLower);
          });
        }

        // Appliquer la visibilité
        if (matchesSearch && matchesTags) {
          cardElement.style.display = '';
          // Petite animation d'apparition
          cardElement.style.opacity = '1';
          cardElement.style.transform = 'translateY(0)';
          visibleCount++;
        } else {
          cardElement.style.display = 'none';
          cardElement.style.opacity = '0';
        }
      });

      // Gestion message "Aucun résultat"
      let noResultsMsg = projectsGrid.querySelector('.search-works__no-results');
      if (visibleCount === 0) {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.className = 'search-works__no-results';
          noResultsMsg.innerHTML = `
            <p>Aucun projet ne correspond à votre recherche.</p>
            <button class="search-works__clear-btn">Tout effacer</button>
          `;
          projectsGrid.appendChild(noResultsMsg);
          
          // Ajouter event sur le bouton "Tout effacer"
          noResultsMsg.querySelector('.search-works__clear-btn')?.addEventListener('click', clearAllFilters);
        }
      } else {
        noResultsMsg?.remove();
      }
    }

    function clearAllFilters() {
      searchQuery = '';
      selectedTags = [];
      if (searchInput) {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input')); // Déclencher le reset UI
        // Reset label
        const wrapper = searchInput.closest('.search-works__search-box');
        const labelWrapper = wrapper?.querySelector('.search-works__input-label-wrapper') as HTMLElement;
        if (labelWrapper) {
          labelWrapper.style.opacity = '1';
          labelWrapper.style.width = 'auto';
        }
      }
      tags.forEach(t => t.classList.remove('search-works__tag--active'));
      updateURL();
      filterProjects();
    }

    // Event Listeners
    const debouncedFilter = debounce(() => {
      updateURL();
      filterProjects();
    }, 300);

    searchInput.addEventListener('input', (e) => {
      searchQuery = (e.target as HTMLInputElement).value;
      toggleResetButton();
      debouncedFilter();
    });

    // Reset button (croix dans l'input)
    if (resetButton) {
      resetButton.addEventListener('click', () => {
        searchQuery = '';
        searchInput.value = '';
        searchInput.focus();
        toggleResetButton();
        
        // Reset label visibility
        const wrapper = searchInput.closest('.search-works__search-box');
        const labelWrapper = wrapper?.querySelector('.search-works__input-label-wrapper') as HTMLElement;
        if (labelWrapper) {
          labelWrapper.style.opacity = '1';
          labelWrapper.style.width = 'auto';
        }
        
        updateURL();
        filterProjects();
      });
    }

    // Tags
    tags.forEach((tag) => {
      tag.addEventListener('click', () => {
        const tagValue = tag.getAttribute('data-tag') || '';
        
        if (selectedTags.includes(tagValue)) {
          selectedTags = selectedTags.filter(t => t !== tagValue);
          tag.classList.remove('search-works__tag--active');
        } else {
          selectedTags.push(tagValue);
          tag.classList.add('search-works__tag--active');
        }
        
        updateURL();
        filterProjects();
      });
    });

    // Init
    readURL();
  }

  // Initialiser
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearchWorks);
  } else {
    // Petit délai pour s'assurer que le DOM Astro est prêt
    setTimeout(initSearchWorks, 50);
  }
  
  // Réinitialiser lors des navigations Astro (View Transitions)
  document.addEventListener('astro:page-load', initSearchWorks);
</script>

<style>
.search-works-section {
  width: 100%;
  background: #FFFEF8;
  padding: 50px 0;
}

.search-works__container {
  width: 100%;
  max-width: 1589px;
  margin: 0 auto;
  padding: 0 109px;
  box-sizing: border-box;
}

.search-works__wrapper {
  width: 100%;
  max-width: 1199px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 40px;
  flex-wrap: wrap;
}

/* Barre de recherche */
.search-works__search-box {
  padding: 14px 20px;
  background: #FFFEF8;
  border: 1.5px solid #E5E7EB; /* Gris plus doux par défaut */
  border-radius: 50px;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 12px;
  position: relative;
  width: 100%;
  max-width: 400px;
  min-height: 48px;
  box-sizing: border-box;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.search-works__search-box:hover {
  border-color: #B0B8B9;
}

.search-works__search-box:focus-within {
  border-color: #048B9A;
  box-shadow: 0 4px 12px rgba(4, 139, 154, 0.1);
}

.search-works__input-label-wrapper {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  flex-shrink: 0;
  position: relative;
  z-index: 0;
  transition: all 0.2s ease;
}

.search-works__input-label {
  color: #5C6D6F;
  font-size: 16px;
  font-family: "Nunito Sans Variable", sans-serif;
  font-weight: 400;
  margin: 0;
  white-space: nowrap;
  pointer-events: none;
}

.search-works__input-real {
  position: absolute;
  left: 20px;
  top: 0;
  width: calc(100% - 80px); /* Espace pour icone et reset */
  height: 100%;
  background: transparent;
  border: none;
  outline: none;
  color: #334749;
  font-size: 16px;
  font-family: "Nunito Sans Variable", sans-serif;
  font-weight: 600;
  padding: 0;
  margin: 0;
  box-sizing: border-box;
  z-index: 1;
}

.search-works__input-real:focus ~ .search-works__input-label-wrapper,
.search-works__input-real:not(:placeholder-shown) ~ .search-works__input-label-wrapper {
  opacity: 0;
  width: 0;
  overflow: hidden;
}

.search-works__icon-wrapper {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  position: absolute; /* Fixe à droite */
  right: 20px;
  pointer-events: none;
  z-index: 0;
}

.search-works__reset {
  position: absolute;
  right: 45px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #5C6D6F;
  z-index: 2;
  border-radius: 50%;
  transition: background 0.2s;
}

.search-works__reset:hover {
  background-color: rgba(0,0,0,0.05);
  color: #334749;
}

/* Tags */
.search-works__tags {
  display: flex;
  justify-content: flex-end;
  align-items: flex-start;
  gap: 8px;
  flex-wrap: wrap;
  width: 100%;
  max-width: 600px;
}

.search-works__tag {
  padding: 8px 16px;
  background: #FFFEF8;
  border: 1px solid #E5E7EB;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  justify-content: center;
  align-items: center;
  font-family: "Nunito Sans Variable", sans-serif;
  color: #5C6D6F;
  font-size: 14px;
}

.search-works__tag:hover {
  border-color: #048B9A;
  color: #048B9A;
  transform: translateY(-1px);
}

.search-works__tag--active {
  background: #048B9A;
  border-color: #048B9A;
  color: #FFFEF8 !important;
}

.search-works__tag--active:hover {
  background: #037480;
  border-color: #037480;
  color: #FFFEF8 !important;
}

.search-works__tag--active .search-works__tag-text {
  color: #FFFEF8;
}

/* No results */
:global(.search-works__no-results) {
  grid-column: 1 / -1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  padding: 60px 20px;
  color: #5C6D6F;
  font-family: "Nunito Sans Variable", sans-serif;
  text-align: center;
  animation: fadeIn 0.3s ease;
}

:global(.search-works__clear-btn) {
  background: none;
  border: 1px solid #5C6D6F;
  padding: 8px 16px;
  border-radius: 20px;
  color: #5C6D6F;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

:global(.search-works__clear-btn:hover) {
  background: #5C6D6F;
  color: #fff;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 1200px) {
  .search-works__container { padding: 0 60px; }
}

@media (max-width: 900px) {
  .search-works__wrapper { 
    flex-direction: column; 
    align-items: center;
    gap: 24px;
  }
  .search-works__search-box { max-width: 100%; }
  .search-works__tags { justify-content: center; }
}

@media (max-width: 480px) {
  .search-works__container { padding: 0 20px; }
  .search-works-section { padding: 30px 0; }
}
</style>
