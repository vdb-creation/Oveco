---
/**
 * Hero Component - Oveco
 * Section héro avec images et cercle suiveur de souris
 * 
 * @component
 */

export interface HeroProps {
  subtitle?: string;
  title: string;
  description?: string;
  ctaText?: string;
  ctaUrl?: string;
  images?: Array<{
    src: string;
    alt: string;
    class?: string;
  }>;
  sectionIndex?: number;
}

const {
  subtitle = "oveco",
  title,
  description = "Des ingénieurs-installateurs qui conçoivent et réalisent votre projet sur mesure.",
  ctaText = "Nous contacter",
  ctaUrl = "#contact",
  sectionIndex = 0,
  images = [
    {
      src: "/uploads/hero/maison-build.png",
      alt: "Maison avec toiture énergétique",
      class: "hero__image hero__image--large-1"
    },
    {
      src: "/uploads/hero/maison-build.png", 
      alt: "Installation énergétique",
      class: "hero__image hero__image--large-2"
    },
    {
      src: "/uploads/hero/maison-build.png",
      alt: "Construction énergétique", 
      class: "hero__image hero__image--medium-1"
    },
    {
      src: "/uploads/hero/maison-build.png",
      alt: "Réalisation énergétique",
      class: "hero__image hero__image--medium-2"
    }
  ]
} = Astro.props;

function mapImageClassAndId(image: { class?: string }, index: number) {
  const raw = (image.class || '').toLowerCase().trim();
  let positionNumber: number | null = null;
  if (raw === 'image 1' || raw === 'image1') positionNumber = 1;
  if (raw === 'image 2' || raw === 'image2') positionNumber = 2;
  if (raw === 'image 3' || raw === 'image3') positionNumber = 3;
  if (raw === 'image 4' || raw === 'image4') positionNumber = 4;

  // Fallback to index order if Tina class not set
  const num = positionNumber ?? (index + 1);

  // Map numbers to internal size modifiers
  const sizeClass = (num === 1)
    ? 'large-1'
    : (num === 2)
    ? 'large-2'
    : (num === 3)
    ? 'medium-1'
    : 'medium-2';

  return {
    id: `img${num}`,
    className: `hero__image hero__image--${sizeClass}`
  };
}
---

<div class="home-page">
  <section class="hero" role="banner" aria-labelledby="hero-title">
    <!-- Cercle suiveur de souris -->
    <div class="hero__mouse-follower" id="mouseFollower" aria-hidden="true"></div>
    
    <div class="container">
      <div class="hero__container">
        {images && images.length > 0 && images.map((image: { src: string; alt: string; class?: string }, index: number) => {
          const mapped = mapImageClassAndId(image, index);
          return (
            <img 
              src={image.src} 
              alt={image.alt} 
              loading={index === 0 ? "eager" : "lazy"}
              decoding="async"
              class={mapped.className}
              id={mapped.id}
              width={index < 2 ? 220 : 240}
              height={index < 2 ? 300 : 200}
              fetchpriority={index === 0 ? "high" : "low"}
              sizes="(max-width: 768px) 0px, (max-width: 1024px) 30vw, (max-width: 1200px) 22vw, 380px"
              data-bind={`sections.${sectionIndex}.images.${index}.src`}
              data-bind-attr="src"
              role="presentation"
            />
          );
        })}
        
        <div class="hero__content">
          <header class="hero__header">
            <p class="hero__subtitle" data-bind={`sections.${sectionIndex}.subtitle`} aria-label="Sous-titre de la section héro">{subtitle}</p>
            <h1 class="hero__title" id="hero-title" data-bind={`sections.${sectionIndex}.title`}>{title}</h1>
          </header>
          <p class="hero__description" data-bind={`sections.${sectionIndex}.description`}>{description}</p>
          <a 
            href={ctaUrl} 
            class="hero__cta" 
            data-bind={`sections.${sectionIndex}.ctaUrl`} 
            aria-label={`${ctaText} - Contactez-nous pour ${title}`}
          >
            <span data-bind={`sections.${sectionIndex}.ctaText`}>{ctaText}</span>
          </a>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
/**
 * Initialize mouse follower circle for hero section
 */
function initMouseFollower() {
  const follower = document.getElementById('mouseFollower') as HTMLElement;
  const heroSection = document.querySelector('.hero') as HTMLElement;

  if (!follower || !heroSection) return;

  // Ensure CSS transform centers the circle
  follower.style.transform = 'translate(-50%, -50%)';

  let targetX = 0;
  let targetY = 0;
  let currentX = 0;
  let currentY = 0;
  let insideHero = false;

  // Aucun snapping à la grille: mouvement fluide directement sous la souris
  const ease = 0.15; // smoothing factor

  function animate() {
    // ease towards the target
    currentX += (targetX - currentX) * ease;
    currentY += (targetY - currentY) * ease;

    // apply as left/top relative to hero (keeps center via translate(-50%, -50%))
    follower.style.left = currentX + 'px';
    follower.style.top = currentY + 'px';

    // show/hide based on whether mouse is inside hero and viewport is desktop
    if (window.innerWidth > 768 && insideHero) {
      if (follower.style.opacity !== '1') follower.style.opacity = '1';
    } else {
      if (follower.style.opacity !== '0') follower.style.opacity = '0';
    }

    requestAnimationFrame(animate);
  }

  // Run animation loop
  animate();

  // Écoute uniquement dans le hero, mouvement fluide
  heroSection.addEventListener('mousemove', (e: MouseEvent) => {
    const rect = heroSection.getBoundingClientRect();
    const relX = e.clientX - rect.left; // position relative au hero
    const relY = e.clientY - rect.top;

    insideHero = relX >= 0 && relX <= rect.width && relY >= 0 && relY <= rect.height;

    if (!insideHero) return;
    targetX = relX;
    targetY = relY;
  }, { passive: true });

  // Hide on resize for small screens
  window.addEventListener('resize', () => {
    if (window.innerWidth <= 768) {
      follower.style.opacity = '0';
    }
  });
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMouseFollower);
} else {
  initMouseFollower();
}
</script>

<style>
/* CSS optimisé pour Lighthouse - Hero section */
.hero {
  position: relative;
  min-height: 100vh;
  min-height: 100dvh; /* Dynamic viewport height pour mobile */
  background-image: url("/src/assets/imgs/BgHome.svg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  padding: clamp(2rem, 5vw, 6rem) clamp(1rem, 3vw, 2rem);
  /* Optimisations performance */
  will-change: transform;
  contain: layout style paint;
}

@media (max-width: 1200px) {
  .hero {
    padding: 5rem 1.5rem;
  }
}

@media (max-width: 768px) {
  .hero {
    padding: 4rem 1.5rem;
    min-height: 80vh;
  }
}

@media (max-width: 480px) {
  .hero {
    min-height: 70vh;
    padding: 3rem 1rem;
  }
}

.hero__container {
  position: static;
  z-index: 2;
  width: 100%;
  max-width: 1280px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding-inline: clamp(16px, 4vw, 80px);
}

/* Cercle suiveur de souris */
.hero__mouse-follower {
  position: absolute;
  width: 120px;
  height: 120px;
  background: radial-gradient(circle at 50% 50%, rgba(4,139,154,0.28), rgba(4,139,154,0.10) 60%, rgba(4,139,154,0.0) 70%);
  border-radius: 50%;
  pointer-events: none;
  z-index: 0;
  transform: translate(-50%, -50%);
  transition: opacity 0.2s ease;
  opacity: 0;
  will-change: transform, opacity;
  mix-blend-mode: normal;
  left: 50%;
  top: 50%;
  filter: blur(6px);
  box-shadow: 0 0 24px rgba(4, 139, 154, 0.22), 0 0 48px rgba(4, 139, 154, 0.12);
}

@media (max-width: 1200px) {
  .hero__mouse-follower {
    width: 100px;
    height: 100px;
    filter: blur(5px);
  }
}

@media (max-width: 768px) {
  .hero__mouse-follower {
    width: 90px;
    height: 90px;
    filter: blur(4px);
  }
}

@media (max-width: 480px) {
  .hero__mouse-follower {
    display: none;
  }
}

/* Positionnement des 4 images - optimisé pour toutes les tailles */
.hero #img1 {
  left: clamp(40px, 6vw, 100px);
  top: clamp(20px, 7vh, 100px);
  z-index: 1;
}

.hero #img2 {
  right: clamp(40px, 6vw, 100px);
  top: clamp(20px, 7vh, 100px);
  z-index: 1;
}

.hero #img3 {
  left: clamp(60px, 9vw, 140px);
  bottom: clamp(4px, 1.5vh, 24px); /* encore plus bas */
  z-index: 1;
}

.hero #img4 {
  right: clamp(60px, 9vw, 140px);
  bottom: clamp(4px, 1.5vh, 24px);
  z-index: 1;
}

/* Mobile: positions avec espacement confortable */
@media (max-width: 768px) {
  .hero #img1 { 
    left: clamp(24px, 5vw, 40px); 
    top: clamp(80px, 12vh, 120px);
  }
  .hero #img2 { 
    right: clamp(24px, 5vw, 40px); 
    top: clamp(80px, 12vh, 120px);
  }
  /* Sur mobile on masque les deux images secondaires pour éviter surcharge visuelle */
  .hero #img3, .hero #img4 { display: none; }
}

/* Tablette : positions avec bon espacement */
@media (min-width: 769px) and (max-width: 1024px) {
  .hero #img1 { 
    left: clamp(40px, 6vw, 70px); 
    top: clamp(30px, 8vh, 80px); 
  }
  .hero #img2 { 
    right: clamp(40px, 6vw, 70px); 
    top: clamp(30px, 8vh, 80px); 
  }
  .hero #img3 { 
    left: clamp(50px, 7vw, 90px); 
    bottom: clamp(4px, 1.25vh, 20px); 
  }
  .hero #img4 { 
    right: clamp(50px, 7vw, 90px); 
    bottom: clamp(4px, 1.25vh, 20px); 
  }
}

/* Desktop standard : positions optimales */
@media (min-width: 1025px) and (max-width: 1399px) {
  .hero #img1 { 
    left: clamp(50px, 7vw, 85px); 
    top: clamp(60px, 9vh, 100px); 
  }
  .hero #img2 { 
    right: clamp(50px, 7vw, 85px); 
    top: clamp(60px, 9vh, 100px); 
  }
  .hero #img3 { 
    left: clamp(65px, 9vw, 120px); 
    bottom: clamp(6px, 2vh, 24px); 
  }
  .hero #img4 { 
    right: clamp(65px, 9vw, 120px); 
    bottom: clamp(6px, 2vh, 24px); 
  }
}

/* Desktop large : positions pour images de taille raisonnable */
@media (min-width: 1400px) {
  .hero #img1 {
    left: 100px;
    top: 120px;
  }
  
  .hero #img2 {
    right: 100px;
    top: 120px;
  }
  
  .hero #img3 {
    left: 130px;
    bottom: 24px;
  }
  
  .hero #img4 {
    right: 130px;
    bottom: 24px;
  }
}

.hero__image {
  position: absolute;
  overflow: hidden;
  border-radius: clamp(16px, 2.5vw, 30px);
  z-index: 1;
  object-fit: cover;
  transition: none;
  will-change: transform;
  transform: translateZ(0);
  contain: layout style paint;
  aspect-ratio: 4/5;
  image-rendering: optimizeQuality;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  user-select: none;
  -webkit-user-select: none;
  pointer-events: none;
}

/* Desktop large : images plus grandes */
@media (min-width: 1400px) {
  .hero__image {
    max-width: 380px;
    max-height: 480px;
  }
}

/* Desktop standard : taille optimale */
@media (min-width: 1025px) and (max-width: 1399px) {
  .hero__image {
    max-width: min(32vw, 340px);
    max-height: min(42vh, 420px);
  }
}

/* Tablette : images plus petites mais visibles */
@media (max-width: 1024px) and (min-width: 769px) {
  .hero__image {
    max-width: min(28vw, 260px);
    max-height: min(35vh, 320px);
    border-radius: clamp(14px, 2vw, 22px);
  }
}

/* Mobile : images petites mais PRÉSENTES */
@media (max-width: 768px) {
  .hero__image {
    max-width: min(24vw, 160px);
    max-height: min(30vh, 200px);
    border-radius: 14px;
  }
}

.hero__image--large-1,
.hero__image--large-2 {
  width: clamp(80px, 14vw, 230px);
  height: clamp(105px, 20vw, 300px);
  will-change: transform;
  transform: translateZ(0);
  contain: layout style paint;
  aspect-ratio: 4/5;
  image-rendering: optimizeQuality;
}

/* Desktop large : grandes images */
@media (min-width: 1400px) {
  .hero__image--large-1,
  .hero__image--large-2 {
    width: 230px;
    height: 300px;
  }
}

/* Desktop standard : taille optimale */
@media (min-width: 1025px) and (max-width: 1399px) {
  .hero__image--large-1,
  .hero__image--large-2 {
    width: clamp(190px, 18vw, 240px);
    height: clamp(240px, 24vw, 300px);
  }
}

/* Tablette : réduire mais garder visibles */
@media (max-width: 1024px) and (min-width: 769px) {
  .hero__image--large-1,
  .hero__image--large-2 {
    width: clamp(170px, 22vw, 220px);
    height: clamp(210px, 28vw, 270px);
  }
}

/* Mobile : petites mais VISIBLES */
@media (max-width: 768px) {
  .hero__image--large-1,
  .hero__image--large-2 {
    width: clamp(120px, 28vw, 170px);
    height: clamp(150px, 30vw, 210px);
  }
}

.hero__image--medium-1,
.hero__image--medium-2 {
  width: clamp(100px, 18vw, 260px);
  height: clamp(90px, 16vw, 220px);
  will-change: transform;
  transform: translateZ(0);
  contain: layout style paint;
  aspect-ratio: 4/3;
  image-rendering: optimizeQuality;
}

/* Desktop large : images moyennes */
@media (min-width: 1400px) {
  .hero__image--medium-1,
  .hero__image--medium-2 {
    width: 260px;
    height: 220px;
  }
}

/* Desktop standard : taille optimale */
@media (min-width: 1025px) and (max-width: 1399px) {
  .hero__image--medium-1,
  .hero__image--medium-2 {
    width: clamp(200px, 18vw, 240px);
    height: clamp(170px, 16vw, 210px);
  }
}

/* Tablette : réduire mais garder visibles */
@media (max-width: 1024px) and (min-width: 769px) {
  .hero__image--medium-1,
  .hero__image--medium-2 {
    width: clamp(170px, 22vw, 230px);
    height: clamp(150px, 19vw, 200px);
  }
}

/* Mobile : petites mais VISIBLES */
@media (max-width: 768px) {
  .hero__image--medium-1,
  .hero__image--medium-2 {
    width: clamp(115px, 18vw, 155px);
    height: clamp(100px, 16vw, 135px);
  }
}

/* Réorganisation responsive forte pour < 768px : on empile le contenu et on repositionne les images statiquement */
@media (max-width: 768px) {
  .hero { 
    min-height: auto; 
    padding-top: clamp(2.5rem, 8vw, 4rem); 
    padding-bottom: clamp(3rem, 10vw, 5rem);
  }
  .hero__container { 
    display: grid;
    grid-template-columns: 1fr;
    grid-auto-rows: auto;
    align-items: start;
    justify-items: center;
    gap: clamp(1.25rem, 5vw, 2rem);
  }
  .hero__image { 
    position: static !important; 
    inset: auto !important; 
    width: clamp(220px, 70vw, 360px); 
    height: auto; 
    aspect-ratio: 4/3; 
    display: block;
    margin: 0 auto; 
    pointer-events: none; 
    opacity: 0.95;
    z-index: 1;
  }
  /* Garder uniquement les deux grandes pour impact visuel */
  .hero__image--medium-1, .hero__image--medium-2 { display: none; }
}

@media (max-width: 480px) {
  .hero__image { 
    width: clamp(190px, 82vw, 320px); 
  }
}

/* Sélecteur sécurité: enlever toute transformation résiduelle des images sur mobile */
@media (max-width: 768px) {
  .hero__image#img1, .hero__image#img2 { transform: none !important; }
}

.hero__content {
  width: min(656px, 100%);
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  gap: clamp(0.75rem, 2vw, 1.125rem);
  z-index: 3;
  padding-inline: clamp(1rem, 3vw, 1.5rem);
  max-width: clamp(320px, 90vw, 720px);
  /* Amélioration mobile */
  min-height: 300px;
  justify-content: center;
}

.hero__content::before {
  content: "";
  width: 334px;
  height: 334px;
  left: -92px;
  top: 369px;
  position: absolute;
  opacity: 0.4;
  background: #334749;
  box-shadow: 531.3636474609px 531.3636474609px 531.3636474609px;
  border-radius: 9999px;
  filter: blur(265.68px);
  z-index: -1;
}

@media (max-width: 1023px) {
  .hero__content::before {
    display: none;
  }
}

/* Mobile : optimiser l'espacement */
@media (max-width: 768px) {
  .hero__content {
    padding-inline: clamp(1.25rem, 5vw, 2rem);
    gap: clamp(1rem, 3vw, 1.5rem);
    min-height: auto;
    padding-block: clamp(2rem, 6vw, 3rem);
  }
}

.hero__header {
  align-self: stretch;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  gap: clamp(0.375rem, 1vw, 0.625rem);
}

.hero__subtitle {
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-size: clamp(0.875rem, 2vw, 1.125rem);
  font-weight: 700;
  line-height: 1.4;
  letter-spacing: clamp(0.08rem, 0.2vw, 0.12rem);
  align-self: stretch;
  text-align: center;
  color: #5C6D6F;
  text-transform: uppercase;
  margin: 0;
}

.hero__title {
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-size: clamp(1.75rem, 5vw, 2.986rem);
  font-weight: 800;
  line-height: 1.2;
  align-self: stretch;
  text-align: center;
  color: #334749;
  margin: 0;
  /* Amélioration lisibilité mobile */
  hyphens: auto;
  word-break: break-word;
}

@media (max-width: 768px) {
  .hero__title {
    font-size: clamp(1.625rem, 6vw, 2.4rem);
    line-height: 1.25;
  }
}

@media (max-width: 480px) {
  .hero__title {
    font-size: clamp(1.5rem, 7vw, 1.95rem);
    line-height: 1.3;
  }
}

.hero__description {
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-size: clamp(1rem, 2vw, 1.125rem);
  font-weight: 400;
  line-height: 1.5;
  align-self: stretch;
  text-align: center;
  color: #5C6D6F;
  margin: 0;
  /* Amélioration lisibilité mobile */
  max-width: 100%;
}

@media (max-width: 768px) {
  .hero__description {
    font-size: clamp(0.95rem, 2.5vw, 1.05rem);
    line-height: 1.6;
  }
}

.hero__cta {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: clamp(14px, 2vw, 18px) clamp(24px, 3vw, 30px);
  background: #334749;
  border-radius: 30px;
  color: #FFFEF8;
  font-size: clamp(16px, 2vw, 19.2px);
  font-family: "Nunito Sans", sans-serif;
  font-weight: 700;
  line-height: 1.2;
  text-align: center;
  text-decoration: none;
  cursor: pointer;
  border: none;
  transition: background 0.3s ease, transform 0.2s ease;
  /* Amélioration accessibilité tactile */
  min-height: 48px;
  min-width: 120px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

.hero__cta:hover,
.hero__cta:focus {
  background: #048B9A;
  transform: translateY(-2px);
}

.hero__cta:focus-visible {
  outline: 3px solid #048B9A;
  outline-offset: 4px;
}

.hero__cta:active {
  transform: translateY(0);
}

@media (max-width: 768px) {
  .hero__cta {
    padding: 16px 28px;
    min-height: 52px;
    font-size: 17px;
  }
}

@media (max-width: 480px) {
  .hero__cta {
    padding: 14px 24px;
    font-size: 16px;
    width: auto;
    max-width: 100%;
  }
}
</style>