---
// Composant de page dynamique réutilisable
import Layout from '../layouts/Layout.astro';
import { pageConfig } from '../lib/routing.ts';

// Composants Oveco disponibles partout
import {
  Autoconstruction,
  WorksHero,
  Contact,
         Hero,
  Expertise,
  Stats,
  Competences,
  Certifications,
  Gallerie,
  TextImage,
  Projects,
  Testimonials,
  SimpleCompetence,
  Footer,
} from '../components';

import { client } from '../../tina/__generated__/client';
import LiveBridge from '../../tina/LiveBridge.tsx';

export interface Props {
  title?: string;
  description?: string;
  jsonFile?: string;
  lang?: string;
}

const { title, description, jsonFile, lang = 'fr' } = Astro.props;
const currentJson = (jsonFile || 'home');

// Fonction pour charger les données JSON
async function loadPageData(jsonFile: string, lang: string = 'fr') {
  try {
    // Essayer d'abord avec la langue spécifique
    try {
      const module = await import(`../../content/${lang}/${jsonFile}.json`);
      return module.default;
    } catch {
      // Fallback vers le fichier de base
      const module = await import(`../../content/${jsonFile}.json`);
      return module.default;
    }
  } catch (e) {
    console.error(`Erreur lors du chargement de ${jsonFile}.json:`, e);
    return null;
  }
}

// Charger les données JSON
const pageData = await loadPageData(jsonFile || 'home', lang);
const pageContent = pageData || {};
const sections = pageContent.sections || [];

// Titre et description par défaut
const pageTitle = title || pageContent.title || "Oveco - Auto-construction et Rénovation Écologique";
const pageDescription = description || pageContent.description || "Oveco accompagne vos projets d'auto-construction et de rénovation écologique. Expertise en maisons passives et énergies renouvelables.";

// Configuration TinaCMS (uniquement pour la page home)
const isHomePage = currentJson === 'home';
const forceLive = isHomePage && (import.meta.env.DEV || Astro.url.searchParams.get('live') === '1' || import.meta.env.PUBLIC_TINA_LIVE === '1');
let tinaData: any = null;

if (forceLive && isHomePage) {
  try {
    const file = `${currentJson}.json`;
    if (lang === 'en') {
      tinaData = await client.queries.homeEn({ relativePath: file });
    } else {
      tinaData = await client.queries.home({ relativePath: file });
    }
  } catch (e) {
    console.log('TinaCMS data not available, using static data');
  }
}
---

<Layout title={pageTitle} description={pageDescription}>
  {tinaData && (
    <LiveBridge client:load home={tinaData} />
  )}

         {sections.map((section: any, index: number) => {
           const typename = section?.__typename || '';
           const rawTemplate = section?._template || typename.replace('HomeSections', '');
           const template = (rawTemplate || '').toString().trim().replace(/\s+/g, '').toLowerCase();

    // ========== Composants Oveco disponibles partout ==========
    
    if (template === 'autoconstruction') {
      return (
        <Autoconstruction
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          services={section.services}
          ctaLabel={section.ctaLabel}
          ctaHref={section.ctaHref}
        />
      );
    }
    
    if (template === 'workshero') {
      return (
        <WorksHero
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          ctaLabel={section.ctaLabel}
          ctaHref={section.ctaHref}
          mediaLeft={section.mediaLeft}
          mediaRight={section.mediaRight}
        />
      );
    }

           // Hero (accueil) – 4 images, background BgHome.svg via SCSS
           if (template === 'hero') {
             return (
               <Hero
                 subtitle={section.subtitle}
                 title={section.title}
                 description={section.description}
                 ctaText={section.ctaText}
                 ctaUrl={section.ctaUrl}
                 images={section.images}
               />
             );
           }
    
    if (template === 'contact') {
      return (
        <Contact
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          contactInfo={section.contactInfo}
          formAction={section.formAction}
        />
      );
    }
    
    if (template === 'expertise') {
      return (
        <Expertise
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          cards={section.cards}
          ctaLabel={section.ctaLabel}
          ctaHref={section.ctaHref}
        />
      );
    }
    
    if (template === 'stats') {
      return (
        <Stats
          title={section.title}
          stats={section.stats}
        />
      );
    }
    
    if (template === 'competences') {
      return (
        <Competences
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          competences={section.competences}
        />
      );
    }
    
           if (template === 'certifications') {
             return (
               <Certifications
                 title={section.title}
                 description={section.description}
                 cards={section.cards}
               />
             );
           }

    if (template === 'certifications') {
      return (
        <Certifications
          title={section.title}
          description={section.description}
          cards={section.cards}
        />
      );
    }
    
    if (template === 'gallerie') {
      return (
        <Gallerie
          subtitle={section.subtitle}
          title={section.title}
          gallery={section.gallery}
        />
      );
    }
    
    if (template === 'textimage') {
      return (
        <TextImage
          sectionSubtitle={section.sectionSubtitle}
          sectionTitle={section.sectionTitle}
          sectionDescription={section.sectionDescription}
          showSectionHeader={section.showSectionHeader}
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          link={section.link}
          image={section.image}
          reverse={section.reverse}
          duplicate={section.duplicate}
          subtitle2={section.subtitle2}
          title2={section.title2}
          description2={section.description2}
          link2={section.link2}
          image2={section.image2}
        />
      );
    }
    
    if (template === 'projects') {
      return (
        <Projects
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          linkText={section.linkText}
          linkUrl={section.linkUrl}
          cards={section.cards}
        />
      );
    }
    
    if (template === 'testimonials') {
      return (
        <Testimonials
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          linkText={section.linkText}
          linkUrl={section.linkUrl}
          testimonials={section.testimonials}
        />
      );
    }
    
    if (template === 'simplecompetence') {
      return (
        <SimpleCompetence
          number={section.number}
          title={section.title}
          description={section.description}
          cta={section.cta}
          image={section.image}
        />
      );
    }
    
    if (template === 'footer') {
      return (
        <Footer
          copyrightYear={section.copyrightYear}
          companyName={section.companyName}
          legalText={section.legalText}
        />
      );
    }
    
    return null;
  })}

  <!-- Slot pour le contenu spécifique à la page -->
  <slot />
</Layout>
