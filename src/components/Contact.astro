---
/**
 * Composant: Contact
 * Section de contact avec informations et formulaire
 * Compatible TinaCMS via props
 */

export interface ContactInfo {
  email?: string;
  phone?: string;
  location?: string;
}

export interface Props {
  subtitle?: string;
  title?: string;
  description?: string;
  contactInfo?: ContactInfo;
  formAction?: string;
  sectionIndex?: number;
}

const {
  subtitle = "Nous contacter",
  title = "Vous avez une idée, un projet, ou simplement des questions ?",
  description = "Écrivez-nous ou appelez-nous, on sera ravi d'en discuter.",
  contactInfo = {
    email: "job@oveco.be",
    phone: "+32 473 / 68.99.02",
    location: "Région de Beauvechain"
  },
  // Envoi par défaut via Web3Forms
  formAction = "https://api.web3forms.com/submit",
  sectionIndex = 0
} = Astro.props;

// Pour les composants globaux (sectionIndex === -1), utiliser un chemin spécial
const getDataBind = (field: string) => {
  if (sectionIndex === -1) {
    return `globalComponents.contact.${field}`;
  }
  return `sections.${sectionIndex}.${field}`;
};
---

<section class="contact-section" id="contact" aria-labelledby="contact-title">
  <div class="contact" itemscope itemtype="https://schema.org/ContactPoint">
    <div class="contact__container">
      <aside class="contact__info" aria-labelledby="contact-title contact-subtitle">
        <div class="contact__info-header">
          <p class="contact__subtitle" id="contact-subtitle" data-bind={getDataBind('subtitle')}>{subtitle}</p>
          <h2 class="contact__title" id="contact-title" data-bind={getDataBind('title')}>{title}</h2>
        </div>
        <p class="contact__description" data-bind={getDataBind('description')}>{description}</p>

        <ul class="contact__list" role="list">
          <li class="contact__item">
            <span class="contact__item-icon" aria-hidden="true">
              <svg width="19" height="15" viewBox="0 0 19 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18.2476 3.14648V11.4798C18.2476 12.0324 18.0281 12.5623 17.6374 12.953C17.2467 13.3437 16.7168 13.5632 16.1642 13.5632H3.66424C3.11171 13.5632 2.5818 13.3437 2.1911 12.953C1.8004 12.5623 1.58091 12.0324 1.58091 11.4798V3.14648" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.2476 3.14681C18.2476 2.59428 18.0281 2.06437 17.6374 1.67367C17.2467 1.28297 16.7168 1.06348 16.1642 1.06348H3.66424C3.11171 1.06348 2.5818 1.28297 2.1911 1.67367C1.8004 2.06437 1.58091 2.59428 1.58091 3.14681L8.81008 7.6607C9.14118 7.86764 9.52378 7.97737 9.91424 7.97737C10.3047 7.97737 10.6873 7.86764 11.0184 7.6607L18.2476 3.14681Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            {contactInfo?.email ? (
              <a class="contact__link contact__link--accent" href={`mailto:${contactInfo.email}`} data-bind={sectionIndex === -1 ? `globalComponents.contact.contactInfo.email` : `sections.${sectionIndex}.contactInfo.email`}>
                {contactInfo.email}
              </a>
            ) : (
              <span class="contact__text contact__text--empty" data-bind={sectionIndex === -1 ? `globalComponents.contact.contactInfo.email` : `sections.${sectionIndex}.contactInfo.email`}>Ajouter un email dans TinaCMS</span>
            )}
          </li>
          
          <li class="contact__item">
            <span class="contact__item-icon contact__item-icon--phone" aria-hidden="true">
              <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.1658 17.5824L12.1749 17.5888C12.962 18.0899 13.8964 18.3075 14.8239 18.2056C15.7514 18.1038 16.6163 17.6886 17.2759 17.0286L17.8488 16.4556C17.9758 16.3287 18.0765 16.1781 18.1452 16.0122C18.2139 15.8464 18.2493 15.6687 18.2493 15.4892C18.2493 15.3097 18.2139 15.1319 18.1452 14.9661C18.0765 14.8003 17.9758 14.6496 17.8488 14.5227L15.4322 12.108C15.3054 11.981 15.1547 11.8803 14.9889 11.8116C14.823 11.7429 14.6453 11.7075 14.4658 11.7075C14.2863 11.7075 14.1085 11.7429 13.9427 11.8116C13.7769 11.8803 13.6262 11.981 13.4993 12.108C13.2431 12.3641 12.8957 12.508 12.5334 12.508C12.1711 12.508 11.8236 12.3641 11.5674 12.108L7.70342 8.24312C7.44727 7.9869 7.30338 7.63943 7.30338 7.27713C7.30338 6.91484 7.44727 6.56737 7.70342 6.31115C7.83039 6.18426 7.93111 6.0336 7.99983 5.86777C8.06855 5.70195 8.10392 5.5242 8.10392 5.3447C8.10392 5.1652 8.06855 4.98746 7.99983 4.82163C7.93111 4.65581 7.83039 4.50515 7.70342 4.37826L5.28777 1.96352C5.03154 1.70737 4.68408 1.56348 4.32178 1.56348C3.95948 1.56348 3.61201 1.70737 3.35579 1.96352L2.78193 2.53646C2.12208 3.1961 1.70702 4.06112 1.60533 4.98858C1.50364 5.91604 1.72141 6.85044 2.22265 7.63739L2.22812 7.6465C4.8753 11.5631 8.24874 14.9359 12.1658 17.5824V17.5824Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            {contactInfo?.phone ? (
              <a class="contact__link contact__link--accent" href={`tel:${contactInfo.phone.replace(/\s/g, '')}`} data-bind={sectionIndex === -1 ? `globalComponents.contact.contactInfo.phone` : `sections.${sectionIndex}.contactInfo.phone`}>
                {contactInfo.phone}
              </a>
            ) : (
              <span class="contact__text contact__text--empty" data-bind={sectionIndex === -1 ? `globalComponents.contact.contactInfo.phone` : `sections.${sectionIndex}.contactInfo.phone`}>Ajouter un téléphone dans TinaCMS</span>
            )}
          </li>
          
          <li class="contact__item">
            <span class="contact__item-icon contact__item-icon--location" aria-hidden="true">
              <svg width="16" height="19" viewBox="0 0 16 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14.7751 8.65382C14.7751 14.0327 9.26589 17.3464 8.121 17.9776C8.05758 18.0126 7.98632 18.0309 7.91389 18.0309C7.84146 18.0309 7.77021 18.0126 7.70678 17.9776C6.56103 17.3464 1.05356 14.0327 1.05356 8.65382C1.05356 4.36584 3.62634 1.36426 7.91432 1.36426C12.2023 1.36426 14.7751 4.36584 14.7751 8.65382Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4.48396 8.2253C4.48396 9.1351 4.84538 10.0076 5.4887 10.6509C6.13202 11.2943 7.00455 11.6557 7.91434 11.6557C8.82414 11.6557 9.69667 11.2943 10.34 10.6509C10.9833 10.0076 11.3447 9.1351 11.3447 8.2253C11.3447 7.31551 10.9833 6.44298 10.34 5.79966C9.69667 5.15634 8.82414 4.79492 7.91434 4.79492C7.00455 4.79492 6.13202 5.15634 5.4887 5.79966C4.84538 6.44298 4.48396 7.31551 4.48396 8.2253V8.2253Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="contact__text" data-bind={sectionIndex === -1 ? `globalComponents.contact.contactInfo.location` : `sections.${sectionIndex}.contactInfo.location`}>
              {contactInfo?.location || "Ajouter une adresse dans TinaCMS"}
            </span>
          </li>
        </ul>
      </aside>

      <div class="contact__panel" aria-label="Formulaire de contact">
        <form class="contact__form" method="POST" action={formAction} novalidate>
          <!-- Web3Forms Access Key (public) -->
          <input type="hidden" name="access_key" value="2f49656a-b6d6-41f0-bc7f-5d7c68340a41" />
          <!-- Métadonnées utiles -->
          <input type="hidden" name="subject" value="Nouveau message depuis le site Oveco" />
          <input type="hidden" name="from_name" value="Formulaire Oveco" />
          <div class="contact__groups">
            <div class="contact__col">
              <div class="contact__field">
                <label class="contact__label" for="contact-name">Nom <span class="required" aria-label="requis">*</span></label>
                <input 
                  id="contact-name" 
                  class="contact__input" 
                  name="name" 
                  type="text" 
                  inputmode="text" 
                  autocomplete="name" 
                  placeholder="John Carter" 
                  required 
                  aria-required="true"
                  aria-describedby="contact-name-error"
                />
                <div id="contact-name-error" class="contact__error" role="alert" aria-live="polite"></div>
              </div>

              <div class="contact__field">
                <label class="contact__label" for="contact-phone">Téléphone</label>
                <input 
                  id="contact-phone" 
                  class="contact__input" 
                  name="phone" 
                  type="tel" 
                  inputmode="tel" 
                  autocomplete="tel" 
                  placeholder="(123) 456 - 789"
                  aria-describedby="contact-phone-error"
                />
                <div id="contact-phone-error" class="contact__error" role="alert" aria-live="polite"></div>
              </div>
            </div>

            <div class="contact__col">
              <div class="contact__field">
                <label class="contact__label" for="contact-email">Email <span class="required" aria-label="requis">*</span></label>
                <input 
                  id="contact-email" 
                  class="contact__input" 
                  name="email" 
                  type="email" 
                  inputmode="email" 
                  autocomplete="email" 
                  placeholder="example@email.com" 
                  required 
                  aria-required="true"
                  aria-describedby="contact-email-error"
                />
                <div id="contact-email-error" class="contact__error" role="alert" aria-live="polite"></div>
              </div>

              <div class="contact__field">
                <label class="contact__label" for="contact-company">Entreprise</label>
                <input 
                  id="contact-company" 
                  class="contact__input" 
                  name="company" 
                  type="text" 
                  inputmode="text" 
                  autocomplete="organization" 
                  placeholder="Oveco"
                  aria-describedby="contact-company-error"
                />
                <div id="contact-company-error" class="contact__error" role="alert" aria-live="polite"></div>
              </div>
            </div>
          </div>

          <div class="contact__field contact__field--message">
            <label class="contact__label" for="contact-message">Message <span class="required" aria-label="requis">*</span></label>
            <textarea 
              id="contact-message" 
              class="contact__textarea" 
              name="message" 
              rows="6" 
              placeholder="Votre message ici..." 
              required 
              aria-required="true"
              aria-describedby="contact-message-error"
            ></textarea>
            <div id="contact-message-error" class="contact__error" role="alert" aria-live="polite"></div>
          </div>

          <div class="contact__actions">
            <button type="submit" class="contact__submit" aria-label="Envoyer le message de contact">
              <span>Envoyer</span>
              <svg class="contact__submit-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M8 1L15 8L8 15M14 8H1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
/* CSS extrait de wp-content/themes/oveco/style.css (contact section) */
.contact-section {
  width: 100%;
  background: #FFFEF8;
  display: flex;
  justify-content: center;
  padding: clamp(40px, 8vw, 120px) clamp(16px, 3vw, 24px);
}

.contact__container {
  width: 100%;
  max-width: 1219px;
  display: grid;
  grid-template-columns: 1fr 616px;
  gap: clamp(24px, 4vw, 40px);
  align-items: start;
}

@media (max-width: 1100px) {
  .contact__container {
    grid-template-columns: 1fr;
    justify-items: center;
    text-align: center;
    gap: clamp(32px, 5vw, 48px);
  }
  
  .contact__info {
    align-items: center;
    max-width: 100%;
  }
  
  .contact__info-header {
    align-items: center;
    text-align: center;
  }
  
  .contact__subtitle,
  .contact__title,
  .contact__description {
    text-align: center;
  }
  
  .contact__list {
    align-items: center;
  }
  
  .contact__panel {
    width: 100%;
    max-width: 616px;
  }
}

@media (max-width: 768px) {
  .contact-section {
    padding: clamp(32px, 6vw, 60px) clamp(20px, 5vw, 32px);
  }
}

@media (max-width: 480px) {
  .contact-section {
    padding: 32px 16px;
  }
  
  .contact__container {
    gap: 28px;
  }
}

.contact__info {
  width: 100%;
  max-width: 502.17px;
  display: inline-flex;
  flex-direction: column;
  gap: 48px;
}

.contact__info-header {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.contact__subtitle {
  color: #5C6D6F;
  font-size: 19.2px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-weight: 700;
  text-transform: uppercase;
  line-height: 20px;
  letter-spacing: 1.92px;
  margin: 0;
}

.contact__title {
  color: #334749;
  font-size: 39.81px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-weight: 800;
  line-height: 47.77px;
  margin: 0;
}

.contact__description {
  color: #5C6D6F;
  font-size: 16px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-weight: 400;
  line-height: 28.8px;
  margin: 0;
}

.contact__list {
  display: flex;
  flex-direction: column;
  gap: 24px;
  margin: 0;
  padding: 0;
  list-style: none;
}

.contact__item {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.contact__text {
  color: #5C6D6F;
  font-size: 19.2px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-weight: 400;
  line-height: 28.8px;
}

.contact__text--empty {
  color: #9CA3AF;
  font-style: italic;
}

.contact__link {
  text-decoration: none;
  font-size: 19.2px;
  line-height: 28.8px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-weight: 400;
}

.contact__link--accent {
  color: #048B9A;
}

.contact__item-icon {
  width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex: 0 0 auto;
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  color: #5C6D6F;
  opacity: 0.8;
}

.contact__item-icon svg {
  display: block;
  width: 19px;
  height: 19px;
}

.contact__item-icon--location {
  width: 16px;
  height: 19px;
}

.contact__item-icon--location svg {
  width: 16px;
  height: 19px;
}

.contact__item-icon:has(svg) {
  background-image: none !important;
}

.contact__panel {
  width: 616px;
  min-height: 682px;
  background: rgba(51, 71, 73, 0.1);
  border-radius: 25px;
  position: relative;
  padding: 65px 40px 40px 40px;
  box-sizing: border-box;
}

.contact__form {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

.contact__groups {
  display: flex;
  gap: 24px;
  align-items: flex-start;
  flex-wrap: wrap;
}

.contact__col {
  display: inline-flex;
  flex-direction: column;
  gap: 32px;
  align-items: flex-start;
}

.contact__field {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.contact__label {
  color: #334749;
  font-family: "DM Sans", "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  font-weight: 700;
  font-size: 18px;
  line-height: 18px;
  margin: 0;
  padding: 0;
}

.contact__input {
  width: 256px;
  height: 72px;
  border-radius: 50px;
  border: 2px solid transparent;
  outline: none;
  background: rgba(255, 254, 248, 0.75);
  padding: 21.5px 24px;
  box-sizing: border-box;
  color: #5C6D6F;
  font-size: 16px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  line-height: 28.8px;
  font-weight: 400;
  transition: border-color var(--transition-fast);
}

.contact__input:focus {
  border-color: #048B9A;
}

.contact__field--message {
  width: 100%;
}

.contact__textarea {
  width: 100%;
  max-width: 536px;
  border-radius: 20px;
  border: 2px solid transparent;
  outline: none;
  background: #FFFEF8;
  padding: 24px;
  box-sizing: border-box;
  color: #5C6D6F;
  font-size: 16px;
  font-family: "Nunito Sans Variable", "Nunito Sans", system-ui, -apple-system, sans-serif;
  line-height: 28.8px;
  font-weight: 400;
  min-height: 172px;
  resize: vertical;
  transition: border-color var(--transition-fast);
}

.contact__textarea:focus {
  border-color: #048B9A;
}

.contact__actions {
  display: flex;
  justify-content: flex-end;
}

.contact__submit {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 18px 30px;
  background: #334749;
  border-radius: 30px;
  color: #FFFEF8;
  font-size: 19.2px;
  font-family: "Nunito Sans", sans-serif;
  font-weight: 700;
  line-height: 23.04px;
  text-align: center;
  border: none;
  text-decoration: none;
  cursor: pointer;
  transition: background 0.3s ease;
}

.contact__submit:hover {
  background: #048B9A;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(51, 71, 73, 0.12);
}

.contact__submit:focus-visible {
  outline: 2px solid #048B9A;
  outline-offset: 2px;
}

.contact__submit-icon {
  margin-left: 8px;
  transition: transform var(--transition-fast);
}

.contact__submit:hover .contact__submit-icon {
  transform: translateX(2px);
}

/* Styles pour les erreurs */
.contact__error {
  color: #dc2626;
  font-size: 14px;
  margin-top: 6px;
  min-height: 20px;
  display: block;
  font-family: "Nunito Sans", sans-serif;
  font-weight: 400;
  line-height: 1.4;
}

.contact__input--error,
.contact__textarea--error {
  border-color: #dc2626 !important;
  background-color: rgba(220, 38, 38, 0.05);
}

.contact__input--error:focus,
.contact__textarea--error:focus {
  border-color: #dc2626 !important;
  box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.required {
  color: #dc2626;
  font-weight: 700;
}
  font-size: 14px;
  margin-top: 4px;
  min-height: 20px;
}

.required {
  color: #dc2626;
  font-weight: bold;
}

@media (max-width: 480px) {
  .contact__submit {
    font-size: 16px;
    padding: 16px 24px;
  }
}

@media (max-width: 640px) {
  .contact__panel {
    width: 100%;
    padding: 40px 20px;
  }
  .contact__groups {
    gap: 16px;
    flex-direction: column;
    width: 100%;
  }
  .contact__col {
    gap: 24px;
    width: 100%;
    align-items: center;
  }
  .contact__field {
    width: 100%;
    align-items: center;
  }
  .contact__input {
    width: 100%;
    max-width: 100%;
    height: 64px;
  }
  .contact__textarea {
    max-width: 100%;
  }
  .contact__actions {
    justify-content: center;
  }
}
</style>

<script>
/**
 * Script de gestion du formulaire de contact
 * - Validation des champs
 * - Gestion de la soumission
 */

// Attendre que le DOM soit chargé
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('.contact__form') as HTMLFormElement;
  if (!form) return;

  // Patterns de validation
  const patterns = {
    email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    phone: /^[\d\s\-\+\(\)\.]+$/,
    name: /^[a-zA-ZÀ-ÿ\s\-']{2,}$/
  };

  // Validation d'un champ
  function validateField(field: HTMLInputElement | HTMLTextAreaElement): boolean {
    const value = field.value.trim();
    const errorDiv = document.getElementById(`${field.id}-error`);
    
    if (!errorDiv) return true;

    let isValid = true;
    let errorMessage = '';

    // Vérifier si requis
    if (field.hasAttribute('required') && !value) {
      isValid = false;
      errorMessage = 'Ce champ est requis';
    }
    // Validation email
    else if (field.type === 'email' && value && !patterns.email.test(value)) {
      isValid = false;
      errorMessage = 'Veuillez entrer une adresse email valide';
    }
    // Validation téléphone
    else if (field.type === 'tel' && value && !patterns.phone.test(value)) {
      isValid = false;
      errorMessage = 'Veuillez entrer un numéro de téléphone valide';
    }
    // Validation nom
    else if (field.name === 'name' && value && !patterns.name.test(value)) {
      isValid = false;
      errorMessage = 'Veuillez entrer un nom valide';
    }

    // Afficher/masquer l'erreur
    errorDiv.textContent = errorMessage;
    field.classList.toggle('contact__input--error', !isValid);
    field.setAttribute('aria-invalid', (!isValid).toString());

    return isValid;
  }

  // Validation en temps réel
  const fields = form.querySelectorAll<HTMLInputElement | HTMLTextAreaElement>('input, textarea');
  fields.forEach(field => {
    field.addEventListener('blur', () => validateField(field));
    field.addEventListener('input', () => {
      if (field.classList.contains('contact__input--error')) {
        validateField(field);
      }
    });
  });

  // Gestion de la soumission (envoi à Web3Forms)
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Valider tous les champs
    let isFormValid = true;
    fields.forEach(field => {
      if (!validateField(field)) {
        isFormValid = false;
      }
    });

    if (!isFormValid) {
      // Focus sur le premier champ en erreur
      const firstError = form.querySelector('.contact__input--error') as HTMLElement;
      firstError?.focus();
      return;
    }

    // Récupérer les données du formulaire
    const formData = new FormData(form);

    // UI: désactiver le bouton submit
    const submitBtn = form.querySelector('.contact__submit') as HTMLButtonElement | null;
    if (submitBtn) submitBtn.disabled = true;

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      const result = await response.json().catch(() => ({}));

      if (response.ok) {
        form.reset();
        alert('Merci ! Votre message a été envoyé avec succès. Nous vous répondrons dans les plus brefs délais.');
      } else {
        const message = (result && (result.message || result.error)) || 'Une erreur est survenue. Veuillez réessayer plus tard.';
        alert(message);
      }
    } catch (error) {
      console.error('Erreur lors de l\'envoi du formulaire:', error);
      alert('Une erreur réseau est survenue. Veuillez réessayer plus tard.');
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });
});

</script>
