---
import { Quote, Star } from 'lucide-astro';
import Anim from './Anim.astro';
import SmartImage from './SmartImage.astro';
import defaultAvatar from '../assets/imgs/default-placeholder.png';

type Testimonial = {
  name: string;
  role: string;
  content: string;
  avatar?: string;
  rating?: number;
  projectRef?: any; // peut être string (ex: project-alpha.json) ou objet (référence Tina)
};

type Props = {
  sectionIndex?: number;
  title?: string;
  testimonials?: Testimonial[];
  lang?: 'fr' | 'en';
};

const defaults: Props = {
  title: 'Ce que disent nos clients',
  testimonials: [
    {
      name: 'Marie Dupont',
      role: 'CEO, TechCorp',
      content:
        "Un travail exceptionnel. L'équipe a dépassé toutes nos attentes et livré un produit de qualité supérieure.",
      rating: 5,
    },
    {
      name: 'Jean Martin',
      role: 'Designer, Creative Studio',
      content:
        'Professionnalisme et créativité au rendez-vous. Je recommande vivement leurs services.',
      rating: 5,
    },
    {
      name: 'Sophie Laurent',
      role: 'Directrice Marketing',
      content:
        'Une collaboration fluide et des résultats impressionnants. Nous sommes ravis du résultat final.',
      rating: 5,
    },
  ],
};

const { title = defaults.title, testimonials = defaults.testimonials, lang = 'fr' } = Astro.props as Props;
const items: Testimonial[] = testimonials ?? [];

function toProjectSlug(ref: any): string | null {
  if (!ref) return null;
  if (typeof ref === 'string') {
    return ref.replace(/^\/*(content\/projects\/)?/, '').replace(/\.json$/, '');
  }
  if (typeof ref === 'object') {
    const candidate = (ref as any)?._sys?.relativePath || (ref as any)?.relativePath || (ref as any)?.id || (ref as any)?.path || '';
    if (typeof candidate === 'string') {
      return candidate.replace(/^\/*(content\/projects\/)?/, '').replace(/\.json$/, '');
    }
  }
  return null;
}
---

<section class="wf-testimonials" id="testimonials">
  <div class="wf-testimonials__container">
    <Anim effect="fade-up" delay={100}>
      <h2 class="wf-testimonials__title" data-bind="testimonials.title">{title}</h2>
    </Anim>
    <div class="wf-testimonials__grid">
      {items.map((t, index) => (
        <Anim effect="fade-up" delay={150 + index * 100}>
          <div class="wf-testimonial-card card">
            <div class="wf-testimonial-card__quote-icon">
              <Quote size={32} />
            </div>
            {t.rating && (
              <div class="wf-testimonial-card__rating">
                {Array.from({ length: t.rating }).map((_) => (
                  <Star size={16} fill="currentColor" />
                ))}
              </div>
            )}
            <p class="wf-testimonial-card__content" data-bind={`testimonials.items.${index}.content`}>{t.content}</p>
            <div class="wf-testimonial-card__author">
              <div class="wf-testimonial-card__avatar">
                <SmartImage
                  cmsSrc={t.avatar}
                  fallback={defaultAvatar}
                  alt={t.name}
                  width={50}
                  aspectRatio={1}
                  layout="fixed"
                  placeholder="dominantColor"
                  breakpoints={[50, 100]}
                  class="wf-testimonial-card__avatar-img"
                />
              </div>
              <div>
                <p class="wf-testimonial-card__name" data-bind={`testimonials.items.${index}.name`}>{t.name}</p>
                <p class="wf-testimonial-card__role" data-bind={`testimonials.items.${index}.role`}>{t.role}</p>
              </div>
            </div>
            {t.projectRef && (
              <div class="wf-testimonial-card__actions">
                <a class="btn" href={(toProjectSlug(t.projectRef) ? `/${lang}/projects/${toProjectSlug(t.projectRef)}/` : '#')}>
                  {lang === 'fr' ? 'Voir le projet' : 'View project'}
                </a>
              </div>
            )}
          </div>
        </Anim>
      ))}
    </div>
  </div>
</section>

<style>
  .wf-testimonials {
    padding: 6rem 0;
    background: var(--surface);
    border-bottom: 2px solid var(--color-border);
  }

  .wf-testimonials__container {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .wf-testimonials__title {
    font-size: 2.5rem;
    margin-bottom: 3rem;
    text-align: center;
    border-bottom: 3px solid var(--color-border);
    padding-bottom: 1rem;
    display: inline-block;
    width: 100%;
  }

  .wf-testimonials__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
  }

  .wf-testimonial-card {
    border: 2px solid var(--color-border);
    padding: 2rem;
    background: var(--surface);
    position: relative;
    transition: transform var(--transition), box-shadow var(--transition);
  }

  .wf-testimonial-card:hover {
    transform: translateY(-10px);
    box-shadow: var(--shadow-lg);
  }

  .wf-testimonial-card__quote-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    color: #eee;
  }

  .wf-testimonial-card__rating {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 1rem;
    color: var(--color-text);
  }

  .wf-testimonial-card__content {
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    color: #555;
  }

  .wf-testimonial-card__author {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 2px solid #eee;
  }

  .wf-testimonial-card__avatar {
    width: 50px;
    height: 50px;
    border: 2px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    background: #f5f5f5;
    flex-shrink: 0;
    transition: transform var(--transition);
    border-radius: 50%;
    overflow: hidden;
  }

  .wf-testimonial-card:hover .wf-testimonial-card__avatar {
    transform: scale(1.1) rotate(5deg);
  }

  .wf-testimonial-card__avatar img,
  .wf-testimonial-card__avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }

  .wf-testimonial-card__name {
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .wf-testimonial-card__role {
    font-size: 0.9rem;
    color: #666;
  }

  /* Animations gérées via <Anim /> */

  @media (max-width: 768px) {
    .wf-testimonials__title {
      font-size: 2rem;
    }
  }
</style>
