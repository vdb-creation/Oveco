---
import Layout from '../../layouts/Layout.astro';
import Nabar from '../../components/Nabar.astro';
import WorksHero from '../../components/WorksHero.astro';
import Competences from '../../components/Competences.astro';
import TextImage from '../../components/TextImage.astro';
import Stats from '../../components/Stats.astro';
import Gallerie from '../../components/Gallerie.astro';
import Projects from '../../components/Projects.astro';
import Contact from '../../components/Contact.astro';
import Footer from '../../components/Footer.astro';
import { getAllProjects, getProjectBySlug } from '../../lib/projects.ts';
import { DEFAULT_FORM_FIELDS } from '../../types/contact.ts';

// Utiliser les champs par défaut (sera mis à jour dynamiquement via globalComponents dans DynamicPage)
// Ici on garde les défauts pour compatibilité, mais idéalement utiliser DynamicPage
const formFieldsToUse = DEFAULT_FORM_FIELDS;

// Génération des pages statiques
export async function getStaticPaths() {
  const projects = await getAllProjects();
  
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project }
  }));
}

// Charger les données du projet pour cette page
const { slug } = Astro.params;
const project = await getProjectBySlug(slug!);

if (!project) {
  throw new Error(`Projet ${slug} non trouvé`);
}

// Données par défaut pour les sections
const defaultCompetences = [
  {
    icon: "/uploads/icons/icon-value1.svg",
    alt: "Innovation",
    title: "Innovation",
    description: "Utilisation des dernières technologies écologiques"
  },
  {
    icon: "/uploads/icons/icon-value2.svg", 
    alt: "Qualité",
    title: "Qualité",
    description: "Matériaux de haute qualité et savoir-faire artisanal"
  },
  {
    icon: "/uploads/icons/icon-value3.svg",
    alt: "Durabilité", 
    title: "Durabilité",
    description: "Solutions durables et respectueuses de l'environnement"
  }
];

const defaultStats = [
  {
    value: "100+",
    label: "Projets réalisés"
  },
  {
    value: "15",
    label: "Années d'expérience"
  },
  {
    value: "98%",
    label: "Clients satisfaits"
  }
];

// Charger les projets similaires depuis le projet ou obtenir d'autres projets automatiquement
let similarProjects = project.similarProjects || [];
if (similarProjects.length === 0) {
  // Si pas de projets similaires définis, charger automatiquement d'autres projets de la même catégorie
  const allProjects = await getAllProjects();
  const otherProjects = allProjects
    .filter(p => p.slug !== project.slug && (p.category === project.category || !project.category))
    .slice(0, 3)
    .map(p => ({
      image: p.thumbnail || p.heroImage || "/uploads/imgs/maison-toit.webp",
      type: p.category || "Projet",
      client: p.client,
      title: p.title,
      url: `/work/${p.slug}`,
      description: p.excerpt || p.description
    }));
  similarProjects = otherProjects.length > 0 ? otherProjects : [
    {
      image: "/uploads/imgs/maison-toit.webp",
      type: "Projet",
      client: "Oveco",
      title: "Découvrez nos autres projets",
      url: "/fr/works",
      description: "Explorez d'autres réalisations de notre équipe."
    }
  ];
}

// Titre et description SEO
const pageTitle = project.metaTitle || `${project.title} - Projet Oveco`;
const pageDescription = project.metaDescription || project.excerpt || `Découvrez le projet ${project.title} réalisé par Oveco.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Navigation -->
  <Nabar />

  <!-- Hero Section Projet -->
  <WorksHero 
    subtitle={project.category}
    title={project.title}
    description={project.excerpt || project.description || ''}
    ctaLabel="Nous contacter"
    ctaHref="#contact"
    mediaLeft={project.heroImage ? { src: project.heroImage, alt: project.title } : { src: "/uploads/imgs/maison-toit.webp", alt: "Image projet" }}
    mediaRight={project.thumbnail ? { src: project.thumbnail, alt: project.title } : { src: "/uploads/imgs/maison-build.webp", alt: "Image projet" }}
    sectionIndex={0}
  />

  <!-- Compétences utilisées -->
  <Competences 
    subtitle="Compétences techniques"
    title="Compétences Utilisées"
    description="Les compétences techniques mises en œuvre pour ce projet."
    competences={project.competences || defaultCompetences}
    sectionIndex={1}
  />

  <!-- Section Texte + Image -->
  <TextImage 
    sectionIndex={2}
    subtitle={project.textImage?.subtitle || "À propos"}
    title={project.textImage?.title || project.title}
    description={project.textImage?.description || project.description || ''}
    image={project.textImage?.image ? { src: project.textImage.image, alt: project.title } : { src: "/uploads/imgs/maison-toit.webp", alt: "Image projet" }}
    reverse={project.textImage?.reverse || false}
  />

  <!-- Statistiques du projet -->
  <Stats 
    title="Chiffres Clés du Projet"
    stats={project.stats || defaultStats}
    sectionIndex={3}
  />

  <!-- Galerie d'images -->
  <Gallerie 
    subtitle="Galerie"
    title="En images"
    gallery={(project.gallery && project.gallery.length > 0) ? project.gallery.map((item: any, index: number) => ({
      src: item.image,
      alt: item.alt || `Image ${index + 1} du projet ${project.title}`
    })) : [
      { src: "/uploads/imgs/maison-toit.webp", alt: "Image du projet" }
    ]}
    sectionIndex={4}
  />

  <!-- Projets similaires -->
  <Projects 
    subtitle="Découvrez aussi"
    title="Autres Projets"
    description="Explorez d'autres réalisations de notre équipe."
    linkText="Voir tous les projets"
    linkUrl="/fr/works"
    cards={similarProjects}
    sectionIndex={5}
  />

  <!-- Contact -->
  <Contact 
    subtitle="Nous contacter"
    title="Vous avez un projet similaire ?"
    description="Contactez-nous pour discuter de votre projet d'auto-construction ou de rénovation écologique."
    contactInfo={{
      email: "contact@oveco.be",
      phone: "+32 473 / 68.99.02",
      location: "Région de Beauvechain, Belgique"
    }}
    formAction="#contact"
    formFields={formFieldsToUse}
    sectionIndex={6}
  />

  <!-- Footer -->
  <Footer 
    copyrightYear={new Date().getFullYear()}
    companyName="Oveco"
    legalText="Tous droits réservés"
  />
</Layout>

<style>
/* Styles spécifiques à la page work */
.work-page {
  /* La page utilise les styles globaux des composants */
}

/* Ajustements pour la page work si nécessaire */
.works-hero {
  background-image: url("/src/assets/imgs/BgGrille.svg");
}

/* Responsive pour la page work */
@media (max-width: 768px) {
  .work-page {
    /* Ajustements mobile si nécessaire */
  }
}
</style>
