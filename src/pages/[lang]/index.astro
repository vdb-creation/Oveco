---
import Layout from '../../layouts/Layout.astro';

// Composants Oveco migrés
import {
  Autoconstruction,
  WorksHero,
  Contact,
  Expertise,
  Stats,
  Competences,
  Certifications,
  Gallerie,
  TextImage,
  Projects,
  Testimonials,
  SimpleCompetence,
  Footer,
} from '../../components';

import { client } from '../../../tina/__generated__/client';
import LiveBridge from '../../../tina/LiveBridge.tsx';

const param = Astro.params.lang as string | undefined;
const currentLang: 'fr' | 'en' = param === 'en' ? 'en' : 'fr';

export function getStaticPaths() {
  return [
    { params: { lang: 'fr' } },
    { params: { lang: 'en' } },
  ];
}

let homeQ: any = null;
const forceLive = import.meta.env.DEV || Astro.url.searchParams.get('live') === '1' || import.meta.env.PUBLIC_TINA_LIVE === '1';
try {
  async function loadWithTimeout(relativePath: string) {
    const tinaPromise = client.queries.home({ relativePath });
    if (forceLive) return await tinaPromise;
    const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('tina-timeout')), 1000));
    return await Promise.race([tinaPromise, timeout]);
  }
  try {
    homeQ = await loadWithTimeout(`${currentLang}/home.json`);
  } catch {
    homeQ = await loadWithTimeout('home.json');
  }
} catch (e) {
  homeQ = null;
}

const H = homeQ?.data?.home || {};
const sections = H.sections || [];

console.log('[i18n index.astro] lang:', currentLang, 'homeQ:', !!homeQ);
---

<Layout
  title="Template Astro Wireframe - Composants prêts à l'emploi"
  description="Template Astro moderne avec une collection de composants wireframe pour démarrer vos projets rapidement."
>
  {homeQ && (
    <LiveBridge client:load home={homeQ} />
  )}

  {sections.map((section: any, index: number) => {
    const typename = section?.__typename || '';
    const template = section?._template || typename.replace('HomeSections', '').toLowerCase();

    // ========== Composants Oveco migrés ==========
    
    if (template === 'autoconstruction') {
      return (
        <Autoconstruction
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          services={section.services}
          ctaLabel={section.ctaLabel}
          ctaHref={section.ctaHref}
        />
      );
    }
    
    if (template === 'workshero') {
      return (
        <WorksHero
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          ctaLabel={section.ctaLabel}
          ctaHref={section.ctaHref}
          mediaLeft={section.mediaLeft}
          mediaRight={section.mediaRight}
        />
      );
    }
    
    if (template === 'contact') {
      return (
        <Contact
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          contactInfo={section.contactInfo}
          formAction={section.formAction}
        />
      );
    }
    
    if (template === 'expertise') {
      return (
        <Expertise
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          cards={section.cards}
          ctaLabel={section.ctaLabel}
          ctaHref={section.ctaHref}
        />
      );
    }
    
    if (template === 'stats') {
      return (
        <Stats
          title={section.title}
          stats={section.stats}
        />
      );
    }
    
    if (template === 'competences') {
      return (
        <Competences
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          competences={section.competences}
        />
      );
    }
    
    if (template === 'certifications') {
      return (
        <Certifications
          title={section.title}
          description={section.description}
          cards={section.cards}
        />
      );
    }
    
    if (template === 'gallerie') {
      return (
        <Gallerie
          subtitle={section.subtitle}
          title={section.title}
          gallery={section.gallery}
        />
      );
    }
    
    if (template === 'textimage') {
      return (
        <TextImage
          sectionSubtitle={section.sectionSubtitle}
          sectionTitle={section.sectionTitle}
          sectionDescription={section.sectionDescription}
          showSectionHeader={section.showSectionHeader}
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          link={section.link}
          image={section.image}
          reverse={section.reverse}
          duplicate={section.duplicate}
          subtitle2={section.subtitle2}
          title2={section.title2}
          description2={section.description2}
          link2={section.link2}
          image2={section.image2}
        />
      );
    }
    
    if (template === 'projects') {
      return (
        <Projects
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          linkText={section.linkText}
          linkUrl={section.linkUrl}
          cards={section.cards}
        />
      );
    }
    
    if (template === 'testimonials') {
      return (
        <Testimonials
          subtitle={section.subtitle}
          title={section.title}
          description={section.description}
          linkText={section.linkText}
          linkUrl={section.linkUrl}
          testimonials={section.testimonials}
        />
      );
    }
    
    if (template === 'simplecompetence') {
      return (
        <SimpleCompetence
          number={section.number}
          title={section.title}
          description={section.description}
          cta={section.cta}
          image={section.image}
        />
      );
    }
    
    if (template === 'footer') {
      return (
        <Footer
          copyrightYear={section.copyrightYear}
          companyName={section.companyName}
          legalText={section.legalText}
        />
      );
    }
    
    return null;
  })}

</Layout>


